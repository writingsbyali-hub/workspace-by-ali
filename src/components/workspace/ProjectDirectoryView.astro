---
interface Project {
  slug: string;
  title: string;
  description?: string;
  category: string;
  visibility: string;
  gated: boolean;
  status: string;
  subProjectCount: number;
  updateCount: number;
  tags: string[];
}

interface Props {
  projects: Project[];
}

const { projects } = Astro.props;
---

<div class="directory-view" id="directoryView">
  <div class="directory-list">
    {projects.map((project) => (
      <div
        class="directory-item"
        data-project-slug={project.slug}
        data-category={project.category}
        data-status={project.status}
      >
        <!-- Project Row -->
        <div class="project-row" data-expandable="true">
          <!-- Expand/Collapse Button -->
          <button
            class="expand-btn"
            aria-label="Expand project"
            data-expanded="false"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="icon-chevron">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>

          <!-- Project Info -->
          <div class="project-info">
            <div class="project-name">
              <a href={`/projects/${project.slug}`} class="project-link">
                {project.title}
              </a>
              {project.gated && (
                <span class="gated-indicator" title="Gated content - acknowledgment required">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="icon-small">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                  </svg>
                </span>
              )}
            </div>
            <div class="project-summary">
              <span class="category-tag">{project.category}</span>
              <span class="stats-text">
                {project.subProjectCount} sub-projects â€¢ {project.updateCount} updates
              </span>
            </div>
          </div>

          <!-- Status Badge -->
          {project.status && project.status !== 'active' && (
            <span class="status-badge">{project.status}</span>
          )}
        </div>

        <!-- Expandable Content (hidden by default) -->
        <div class="project-details" data-details-for={project.slug} style="display: none;">
          <div class="loading-state">
            <div class="spinner"></div>
            <span>Loading sub-projects...</span>
          </div>
        </div>
      </div>
    ))}
  </div>
</div>

<style>
  .directory-view {
    width: 100%;
  }

  .directory-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Directory Item */
  .directory-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    overflow: hidden;
    transition: all 0.2s;
  }

  .directory-item:hover {
    border-color: var(--primary-light);
  }

  /* Project Row */
  .project-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    cursor: pointer;
    user-select: none;
  }

  .project-row:hover {
    background: var(--bg-hover);
  }

  /* Expand Button */
  .expand-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .expand-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .icon-chevron {
    width: 1rem;
    height: 1rem;
    transition: transform 0.2s;
  }

  .expand-btn[data-expanded="true"] .icon-chevron {
    transform: rotate(90deg);
  }

  /* Project Info */
  .project-info {
    flex: 1;
    min-width: 0;
  }

  .project-name {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .project-link {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    transition: color 0.2s;
  }

  .project-link:hover {
    color: var(--primary);
  }

  .gated-indicator {
    display: flex;
    align-items: center;
    color: var(--warning);
  }

  .icon-small {
    width: 1rem;
    height: 1rem;
  }

  .project-summary {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
  }

  .category-tag {
    padding: 0.125rem 0.5rem;
    background: var(--primary-bg);
    color: var(--primary);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .stats-text {
    color: var(--text-muted);
  }

  .status-badge {
    padding: 0.375rem 0.75rem;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
    flex-shrink: 0;
  }

  /* Project Details (Expandable Section) */
  .project-details {
    border-top: 1px solid var(--border-color);
    padding: 1.5rem;
    background: var(--bg-primary);
  }

  .loading-state {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-muted);
    font-size: 0.875rem;
  }

  .spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid var(--border-color);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Sub-project List (will be populated dynamically) */
  .sub-project-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .sub-project-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .sub-project-item:hover {
    border-color: var(--primary);
    transform: translateX(4px);
  }

  .sub-project-item.gated {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .sub-project-item.gated:hover {
    transform: none;
    border-color: var(--border-color);
  }

  .sub-project-icon {
    width: 2rem;
    height: 2rem;
    background: var(--bg-hover);
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    flex-shrink: 0;
  }

  .sub-project-icon svg {
    width: 1.125rem;
    height: 1.125rem;
  }

  .sub-project-content {
    flex: 1;
    min-width: 0;
  }

  .sub-project-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.125rem;
  }

  .sub-project-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .lock-icon {
    width: 1.125rem;
    height: 1.125rem;
    color: var(--warning);
    flex-shrink: 0;
  }

  /* Empty State */
  .empty-subprojects {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-muted);
    font-size: 0.875rem;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .project-row {
      padding: 0.875rem 1rem;
      gap: 0.75rem;
    }

    .project-link {
      font-size: 1rem;
    }

    .project-summary {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.375rem;
    }

    .status-badge {
      display: none;
    }
  }
</style>

<script>
  // Expand/collapse functionality
  document.querySelectorAll('.expand-btn').forEach((btn) => {
    const projectRow = btn.closest('.project-row');
    const directoryItem = btn.closest('.directory-item');
    const projectSlug = directoryItem?.getAttribute('data-project-slug');
    const detailsSection = directoryItem?.querySelector(`[data-details-for="${projectSlug}"]`);

    if (!projectRow || !detailsSection) return;

    // Click on expand button
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isExpanded = btn.getAttribute('data-expanded') === 'true';

      if (isExpanded) {
        // Collapse
        btn.setAttribute('data-expanded', 'false');
        detailsSection.style.display = 'none';
      } else {
        // Expand
        btn.setAttribute('data-expanded', 'true');
        detailsSection.style.display = 'block';

        // Load sub-projects if not already loaded
        if (!detailsSection.hasAttribute('data-loaded')) {
          await loadSubProjects(projectSlug, detailsSection);
          detailsSection.setAttribute('data-loaded', 'true');
        }
      }
    });

    // Click anywhere on project row to expand/collapse
    projectRow.addEventListener('click', (e) => {
      // Don't trigger if clicking on a link
      if ((e.target as HTMLElement).closest('a')) return;

      btn.click();
    });
  });

  // Function to load sub-projects dynamically
  async function loadSubProjects(projectSlug: string, detailsSection: HTMLElement) {
    try {
      // Fetch sub-projects from API
      const response = await fetch(`/api/projects/${projectSlug}/subprojects`);

      if (!response.ok) {
        throw new Error('Failed to load sub-projects');
      }

      const subProjects = await response.json();

      // Clear loading state
      detailsSection.innerHTML = '';

      if (subProjects.length === 0) {
        detailsSection.innerHTML = `
          <div class="empty-subprojects">
            <p>No sub-projects yet for this project.</p>
          </div>
        `;
        return;
      }

      // Render sub-projects
      const listHtml = `
        <div class="sub-project-list">
          ${subProjects.map((sp: any) => `
            <a
              href="/projects/${projectSlug}/${sp.slug}"
              class="sub-project-item ${sp.gated ? 'gated' : ''}"
              ${sp.gated ? 'data-gated="true"' : ''}
            >
              <div class="sub-project-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
              </div>
              <div class="sub-project-content">
                <div class="sub-project-title">${sp.title}</div>
                <div class="sub-project-meta">${sp.updateCount || 0} updates</div>
              </div>
              ${sp.gated ? `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="lock-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
              ` : ''}
            </a>
          `).join('')}
        </div>
      `;

      detailsSection.innerHTML = listHtml;

      // Add click handlers for gated content
      detailsSection.querySelectorAll('[data-gated="true"]').forEach((el) => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          // TODO: Open gating modal
          alert('This content requires safety acknowledgment. Feature coming soon!');
        });
      });

    } catch (error) {
      console.error('Error loading sub-projects:', error);
      detailsSection.innerHTML = `
        <div class="empty-subprojects">
          <p style="color: var(--error);">Failed to load sub-projects. Please try again.</p>
        </div>
      `;
    }
  }
</script>
