---
import '../../styles/global.css';
import { createSupabaseServer } from '../../lib/supabaseServer';
import { getUserRepoInfo } from '../../lib/getUserRepoInfo';
import PublicHeader from '../navigation/PublicHeader.astro';
import PublicFooter from '../navigation/PublicFooter.astro';
import { PreferencesWrapper } from '../providers/PreferencesWrapper';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Workspace - Research Platform" } = Astro.props;

// Get current path for active state
const currentPath = Astro.url.pathname;

// Check if user is authenticated (optional for public pages)
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

// Get user's GitHub repo info for preferences system
let repoInfo = null;
if (user) {
  repoInfo = await getUserRepoInfo(supabase, user.id);
}

// Check if user is the owner and fetch workspace settings
let isOwner = false;
let workspaceInfo = {
  name: 'Workspace',
  tagline: 'A self-hosted research platform for transparent, collaborative science.',
  socialLinks: [],
};

if (user) {
  const { data: workspaceSettings } = await supabase
    .from('workspace_settings')
    .select('owner_id, workspace_name')
    .single();

  isOwner = user.id === workspaceSettings?.owner_id;

  if (workspaceSettings?.workspace_name) {
    workspaceInfo.name = workspaceSettings.workspace_name;
  }

  // TODO: Add these fields to workspace_settings table:
  // - tagline (text)
  // - social_links (jsonb array)
  // For now, using default values
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>

    <!-- Theme bridge script for syncing localStorage with GitHub preferences -->
    <script src="/src/scripts/theme-bridge.ts"></script>
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <PreferencesWrapper client:load repoInfo={repoInfo}>
      <div class="workspace-container">
        <!-- Public Header -->
        <PublicHeader currentPath={currentPath} isOwner={isOwner} user={user} />

        <!-- Main Content -->
        <main id="main-content" class="workspace-main">
          <slot />
        </main>

        <!-- Public Footer -->
        <PublicFooter
          workspaceName={workspaceInfo.name}
          tagline={workspaceInfo.tagline}
          socialLinks={workspaceInfo.socialLinks}
        />
      </div>
    </PreferencesWrapper>

    <style>
      /* Minimal layout container styles */
      .workspace-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
      }

      /* Main Content */
      .workspace-main {
        flex: 1;
        max-width: 1280px;
        width: 100%;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .workspace-main {
          padding: 1rem;
        }
      }
    </style>
  </body>
</html>
