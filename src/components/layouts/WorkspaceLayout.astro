---
import '../../styles/global.css';
import { createSupabaseServer } from '../../lib/supabaseServer';
import ThemeToggle from '../ui/ThemeToggle';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Workspace - Research Platform" } = Astro.props;

// Get current path for active state
const currentPath = Astro.url.pathname;
const isActive = (path: string) => {
  if (path === '/' && currentPath === '/') return true;
  if (path !== '/' && currentPath.startsWith(path)) return true;
  return false;
};

// Check if user is authenticated (optional for public pages)
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

// Check if user is the owner
let isOwner = false;
if (user) {
  const { data: workspaceSettings } = await supabase
    .from('workspace_settings')
    .select('owner_id')
    .single();

  isOwner = user.id === workspaceSettings?.owner_id;
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
  </head>
  <body>
    <div class="workspace-container">
      <!-- Public Header -->
      <header class="workspace-header">
        <div class="header-content">
          <div class="header-left">
            <a href="/" class="logo-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
              </svg>
              <span class="logo-text">Workspace</span>
            </a>
          </div>

          <nav class="header-nav">
            <a href="/" class={`nav-link ${isActive('/') && currentPath === '/' ? 'active' : ''}`}>
              Home
            </a>
            <a href="/projects" class={`nav-link ${isActive('/projects') ? 'active' : ''}`}>
              Projects
            </a>
            <a href="/updates" class={`nav-link ${isActive('/updates') ? 'active' : ''}`}>
              Updates
            </a>
            <a href="/docs" class={`nav-link ${isActive('/docs') ? 'active' : ''}`}>
              Docs
            </a>
            <a href="/about" class={`nav-link ${isActive('/about') ? 'active' : ''}`}>
              About
            </a>
            <a href="/safety" class={`nav-link ${isActive('/safety') ? 'active' : ''}`}>
              Safety
            </a>
          </nav>

          <div class="header-right">
            <ThemeToggle client:load />

            {isOwner ? (
              <a href="/workbench" class="btn-workbench">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
                </svg>
                Workbench
              </a>
            ) : user ? (
              <a href="/login" class="btn-login">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Profile
              </a>
            ) : (
              <a href="/login" class="btn-login">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                </svg>
                Login
              </a>
            )}
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="workspace-main">
        <slot />
      </main>

      <!-- Footer -->
      <footer class="workspace-footer">
        <div class="footer-content">
          <div class="footer-section">
            <h3>Workspace</h3>
            <p>A self-hosted research platform for transparent, collaborative science.</p>
          </div>

          <div class="footer-section">
            <h4>Quick Links</h4>
            <ul class="footer-links">
              <li><a href="/projects">Projects</a></li>
              <li><a href="/updates">Updates</a></li>
              <li><a href="/about">About</a></li>
              <li><a href="/safety">Safety</a></li>
            </ul>
          </div>

          <div class="footer-section">
            <h4>For Researchers</h4>
            <ul class="footer-links">
              <li><a href="/start">Get Started</a></li>
              <li><a href="https://github.com/yourusername/workspace" target="_blank">Fork on GitHub</a></li>
              <li><a href="https://docs.workspace.com" target="_blank">Documentation</a></li>
            </ul>
          </div>

          <div class="footer-section">
            <p class="footer-copyright">
              Â© {new Date().getFullYear()} Workspace. Open-source research platform.
            </p>
          </div>
        </div>
      </footer>
    </div>

    <style>
      .workspace-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
      }

      /* Header Styles */
      .workspace-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(10px);
        background: rgba(var(--bg-secondary-rgb), 0.95);
      }

      .header-content {
        max-width: 1280px;
        margin: 0 auto;
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .logo-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1.125rem;
      }

      .logo-link:hover {
        color: var(--primary);
      }

      .logo-text {
        font-size: 1.25rem;
        font-weight: 700;
      }

      .header-nav {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex: 1;
      }

      .nav-link {
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
      }

      .nav-link:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }

      .nav-link.active {
        color: var(--primary);
        background: var(--primary-bg);
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .btn-workbench, .btn-login {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-workbench {
        background: var(--primary);
        color: white;
      }

      .btn-workbench:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .btn-login {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-login:hover {
        background: var(--bg-secondary);
        border-color: var(--primary);
      }

      /* Main Content */
      .workspace-main {
        flex: 1;
        max-width: 1280px;
        width: 100%;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Footer Styles */
      .workspace-footer {
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        margin-top: 4rem;
      }

      .footer-content {
        max-width: 1280px;
        margin: 0 auto;
        padding: 3rem 2rem 2rem;
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 2rem;
      }

      .footer-section h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }

      .footer-section h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
      }

      .footer-section p {
        color: var(--text-muted);
        line-height: 1.6;
      }

      .footer-links {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .footer-links li {
        margin-bottom: 0.5rem;
      }

      .footer-links a {
        color: var(--text-muted);
        text-decoration: none;
        transition: color 0.2s;
      }

      .footer-links a:hover {
        color: var(--primary);
      }

      .footer-copyright {
        margin-top: 1rem;
        font-size: 0.875rem;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          padding: 1rem;
        }

        .header-nav {
          flex-wrap: wrap;
          justify-content: center;
          gap: 0.5rem;
        }

        .footer-content {
          grid-template-columns: 1fr;
          gap: 2rem;
        }

        .workspace-main {
          padding: 1rem;
        }
      }
    </style>
  </body>
</html>
