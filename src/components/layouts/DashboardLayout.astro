---
import '../../styles/global.css';
import { createSupabaseServer } from '../../lib/supabaseServer';
import ProjectSwitcher from '../ui/ProjectSwitcher';
import ThemeToggle from '../ui/ThemeToggle';
import ErrorBoundary from '../ui/ErrorBoundary';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Workspace Dashboard" } = Astro.props;

// Get current path for active state
const currentPath = Astro.url.pathname;
const isActive = (path: string) => {
  if (path === '/workbench' && (currentPath === '/workbench' || currentPath === '/workbench/')) return true;
  if (path !== '/workbench' && currentPath.startsWith(path)) return true;
  return false;
};

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user: authUser } } = await supabase.auth.getUser();
const userEmail = authUser?.email || 'User';

// TODO: Fetch projects from Git via Keystatic reader for project switcher
// For now, hide project switcher until we build /workbench/projects page
let projects = [];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Left Sidebar -->
      <aside class="sidebar-left">
        <!-- Logo -->
        <div class="logo">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
          </svg>
          Workbench
        </div>

        <!-- Project Switcher -->
        <div class="sidebar-section">
          <ProjectSwitcher client:load projects={projects} />
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav">
          <a href="/workbench" class={`nav-item ${isActive('/workbench') ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            Dashboard
          </a>

          <a href="/keystatic" class={`nav-item ${isActive('/keystatic') ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
            Content Editor
          </a>

          <div class="border-t border-gray-200 my-4"></div>

          <a href="/" class={`nav-item ${isActive('/') && !currentPath.startsWith('/workbench') ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
            </svg>
            View Public Site
          </a>

          <div class="border-t border-gray-200 my-4"></div>

          <a href="/workbench/settings" class={`nav-item ${isActive('/workbench/settings') ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Settings
          </a>

          <a href="/workbench/profile" class={`nav-item ${isActive('/workbench/profile') ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Profile
          </a>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
          <!-- Theme Toggle -->
          <div class="flex items-center justify-between px-4 py-3 mb-2">
            <span class="text-sm font-medium">Theme</span>
            <ThemeToggle client:load />
          </div>

          <!-- User Profile -->
          <div class="user-profile">
            <div class="user-avatar">
              {userEmail[0].toUpperCase()}
            </div>
            <div class="user-info flex-1">
              <p class="truncate">{userEmail}</p>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="dashboard-main">
        <!-- Mobile Header -->
        <div class="lg:hidden flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
          <h1 class="text-xl font-bold">Workspace</h1>
          <button id="mobile-menu-btn" class="action-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
          </button>
        </div>

        <ErrorBoundary client:only="react">
          <slot />
        </ErrorBoundary>
      </main>

      <!-- Right Sidebar -->
      <aside class="sidebar-right">
        <slot name="sidebar-right" />
      </aside>
    </div>

    <style>
      /* Main Dashboard Container - 3 Column Grid */
      .dashboard-container {
        display: grid;
        grid-template-columns: 260px 1fr 320px; /* Left | Main | Right */
        grid-template-areas: "sidebar-left main sidebar-right";
        height: 100vh;
        width: 100%;
      }

      /* Left Sidebar */
      .sidebar-left {
        grid-area: sidebar-left;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-default);
        overflow-y: auto;
        height: 100vh;
      }

      /* Main Content Area */
      .dashboard-main {
        grid-area: main;
        background: var(--bg-primary);
        overflow-y: auto;
        height: 100vh;
        padding: 32px;
      }

      /* Right Sidebar - Clean, Single Background */
      .sidebar-right {
        grid-area: sidebar-right;
        background: var(--bg-secondary); /* One consistent background */
        border-left: 1px solid var(--border-default);
        overflow-y: auto;
        height: 100vh;
        padding: 0;
        width: 320px;
      }

      /* Sidebar Sections - NO background change, just dividers */
      .sidebar-right :global(.sidebar-section) {
        padding: 20px;
        border-bottom: 1px solid var(--border-default); /* DIVIDER LINE */
        /* NO background property - inherits from parent */
      }

      .sidebar-right :global(.sidebar-section:last-child) {
        border-bottom: none; /* No divider after last section */
      }

      /* Compact sections (like Publish Status) */
      .sidebar-right :global(.sidebar-section.compact) {
        padding: 16px 20px;
      }

      /* Gradient section (Getting Started) - This one CAN have background */
      .sidebar-right :global(.sidebar-section.highlight) {
        background: linear-gradient(135deg, #00D084 0%, #00A368 100%);
        color: white;
        padding: 24px 20px;
        border-bottom: none; /* No divider on gradient */
      }

      /* Section Title - Clean Label Style */
      .sidebar-right :global(.section-title) {
        font-size: 11px; /* Smaller */
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.8px; /* More spacing */
        color: var(--text-tertiary); /* Lighter gray */
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Icon in section title */
      .sidebar-right :global(.section-title svg) {
        width: 14px;
        height: 14px;
        opacity: 0.6;
      }

      /* Gradient section titles stay white */
      .sidebar-right :global(.sidebar-section.highlight .section-title) {
        color: white;
        font-size: 16px;
        text-transform: none;
        letter-spacing: 0;
        opacity: 1;
      }

      /* Notification badge */
      .sidebar-right :global(.badge) {
        background: var(--error);
        color: white;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 16px;
        text-align: center;
      }

      /* Quick Actions Buttons */
      .sidebar-right :global(.btn-block) {
        width: 100%;
        justify-content: center;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      /* Primary button (New Project) */
      .sidebar-right :global(.btn-primary) {
        background: var(--primary);
        color: white;
        border: none;
      }

      .sidebar-right :global(.btn-primary:hover) {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      /* Secondary button (New Update) */
      .sidebar-right :global(.btn-secondary) {
        background: white;
        color: var(--text-primary);
        border: 1.5px solid var(--border-default);
      }

      .sidebar-right :global(.btn-secondary:hover) {
        border-color: var(--border-emphasis);
        background: var(--bg-hover);
      }

      /* Ghost button (View Projects) */
      .sidebar-right :global(.btn-ghost) {
        background: transparent;
        color: var(--text-secondary);
        border: none;
      }

      .sidebar-right :global(.btn-ghost:hover) {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      /* Small buttons (Learn More, etc) */
      .sidebar-right :global(.btn-sm) {
        padding: 8px 16px;
        font-size: 13px;
      }

      /* Publish Status Indicator */
      .sidebar-right :global(.status-indicator) {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: rgba(0, 208, 132, 0.08);
        border-radius: 8px;
        border: 1px solid var(--primary);
      }

      .sidebar-right :global(.status-icon) {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        flex-shrink: 0;
      }

      .sidebar-right :global(.status-text) {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
      }

      /* Notification Item */
      .sidebar-right :global(.notification-item) {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        transition: all 0.15s ease;
        cursor: pointer;
      }

      .sidebar-right :global(.notification-item:hover) {
        background: var(--bg-hover);
      }

      .sidebar-right :global(.notification-empty) {
        text-align: center;
        padding: 24px 16px;
        color: var(--text-secondary);
        font-size: 13px;
        line-height: 1.5;
      }

      /* Responsive Breakpoints */

      /* Tablet - Hide right sidebar, show at bottom */
      @media (max-width: 1279px) {
        .dashboard-container {
          grid-template-columns: 260px 1fr;
          grid-template-areas:
            "sidebar-left main"
            "sidebar-left sidebar-right";
          grid-template-rows: 1fr auto;
        }

        .sidebar-right {
          border-left: none;
          border-top: 1px solid var(--border-default);
          height: auto;
          max-height: 50vh;
        }
      }

      /* Mobile - Single column, sidebar collapses */
      @media (max-width: 768px) {
        .dashboard-container {
          grid-template-columns: 1fr;
          grid-template-areas:
            "main"
            "sidebar-right";
          grid-template-rows: 1fr auto;
        }

        .sidebar-left {
          display: none; /* Show as hamburger menu */
        }

        .dashboard-main {
          padding: 20px;
        }
      }

      /* Custom Scrollbars */
      .sidebar-left::-webkit-scrollbar,
      .dashboard-main::-webkit-scrollbar {
        width: 8px;
      }

      .sidebar-left::-webkit-scrollbar-track,
      .dashboard-main::-webkit-scrollbar-track {
        background: transparent;
      }

      .sidebar-left::-webkit-scrollbar-thumb,
      .dashboard-main::-webkit-scrollbar-thumb {
        background: var(--border-emphasis);
        border-radius: 4px;
      }

      /* Clean scrollbar for right sidebar */
      .sidebar-right::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar-right::-webkit-scrollbar-track {
        background: transparent;
      }

      .sidebar-right::-webkit-scrollbar-thumb {
        background: var(--border-emphasis);
        border-radius: 3px;
      }

      .sidebar-right::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
      }

      /* Dark Mode - Ensure dividers are visible */
      [data-theme="dark"] .sidebar-left {
        background: var(--bg-secondary);
        border-right-color: var(--border-default);
      }

      [data-theme="dark"] .dashboard-main {
        background: var(--bg-primary);
      }

      [data-theme="dark"] .sidebar-right {
        background: var(--bg-secondary);
        border-left-color: var(--border-default);
      }

      [data-theme="dark"] .sidebar-right :global(.sidebar-section) {
        border-bottom-color: var(--border-default);
      }

      [data-theme="dark"] .sidebar-right :global(.section-title) {
        color: var(--text-tertiary);
      }

      [data-theme="dark"] .sidebar-right :global(.status-indicator) {
        background: rgba(0, 208, 132, 0.1);
        border-color: rgba(0, 208, 132, 0.3);
      }
    </style>
  </body>
</html>
