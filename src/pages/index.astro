---
import DashboardLayout from '../components/layouts/DashboardLayout.astro';
import WelcomeHeader from '../components/dashboard/WelcomeHeader';
import StatsBar from '../components/dashboard/StatsBar';
import TaskList from '../components/dashboard/TaskList';
import NotificationList from '../components/dashboard/NotificationList';
import QuickActions from '../components/dashboard/QuickActions';
import GettingStarted from '../components/dashboard/GettingStarted';
import ActivityLog from '../components/ui/ActivityLog';
import PublishWidget from '../components/ui/PublishWidget';
import { createSupabaseServer } from '../lib/supabaseServer';
import { getTasks, getNotifications } from '../lib/github';

// Get user
const supabase = createSupabaseServer(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Get user's first name or email
const userName = user.user_metadata?.name?.split(' ')[0] || user.email?.split('@')[0] || 'there';

// Check if user is the workspace owner
// For now, assume the logged-in user is the owner
// In a full implementation, this would check against workspace ownership
const isOwner = true; // TODO: Implement proper ownership check

// Fetch real data from database
const { data: projects } = await supabase
  .from('projects')
  .select('id')
  .eq('owner', user.id);

const { data: activities } = await supabase
  .from('activities')
  .select('*, projects(name)')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false })
  .limit(10);

const { data: subprojects } = await supabase
  .from('subprojects')
  .select('id, project_id')
  .in('project_id', (projects || []).map(p => p.id));

const { data: documents } = await supabase
  .from('documents')
  .select('id')
  .eq('owner', user.id);

// Calculate stats (handle null values from failed queries)
const stats = {
  projects: projects?.length || 0,
  subprojects: subprojects?.length || 0,
  updates: activities?.length || 0,
  documents: documents?.length || 0,
};

// Transform activities for ActivityLog component
const recentActivities = (activities || []).slice(0, 5).map((activity) => ({
  id: activity.id,
  title: activity.title,
  description: activity.content?.substring(0, 150),
  timestamp: new Date(activity.created_at),
  type: activity.type || 'update',
}));

// Fetch GitHub tasks and notifications
// For now, use empty arrays if no GitHub token is available
let tasks: any[] = [];
let notifications: any[] = [];

try {
  // Check if user has GitHub token stored
  const { data: userRepo } = await supabase
    .from('user_repos')
    .select('github_token')
    .eq('user_id', user.id)
    .single();

  if (userRepo?.github_token) {
    // Fetch tasks and notifications from GitHub
    const { data: repoInfo } = await supabase
      .from('user_repos')
      .select('repo_owner, repo_name')
      .eq('user_id', user.id)
      .single();

    if (repoInfo) {
      tasks = await getTasks(userRepo.github_token, repoInfo.repo_owner, repoInfo.repo_name);
      notifications = await getNotifications(userRepo.github_token);
    }
  }
} catch (error) {
  console.error('Error fetching GitHub data:', error);
  // Use empty arrays as fallback
}
---

<DashboardLayout title="Dashboard - Workspace">
  <!-- Welcome Header -->
  <WelcomeHeader client:load userName={userName} />

  <!-- Compact Stats Bar (Phase 2: Less prominent) -->
  <StatsBar
    client:load
    projects={stats.projects}
    subprojects={stats.subprojects}
    updates={stats.updates}
    documents={stats.documents}
  />

  <!-- Main Content -->
  <div class="dashboard-content">
    <!-- Task List - PROMINENT (Phase 2: Highest Priority) -->
    <!-- Context-aware: Only show create button for owners -->
    <TaskList
      client:load
      tasks={tasks}
      maxVisible={5}
      showCreateButton={isOwner}
    />

    <!-- Recent Updates -->
    <div class="content-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h2 class="section-title">Recent Updates</h2>
      </div>
      <ActivityLog client:load activities={recentActivities} limit={4} />
    </div>
  </div>

  <!-- Right Sidebar - Tool Panel -->
  <div slot="sidebar-right">
    {isOwner && (
      <>
        <!-- Notifications Section -->
        <div class="sidebar-section">
          <NotificationList
            client:load
            notifications={notifications}
            maxVisible={5}
            showMarkAllRead={true}
          />
        </div>

        <!-- Quick Actions Section -->
        <div class="sidebar-section">
          <QuickActions client:load />
        </div>

        <!-- Publish Status Section (Compact) -->
        <div class="sidebar-section compact">
          <PublishWidget client:load />
        </div>
      </>
    )}

    {!isOwner && (
      <!-- Visitor View: Show how to contribute -->
      <div class="sidebar-section">
        <h3 class="section-title">Want to Contribute?</h3>
        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">
          Check out the tasks to see how you can help!
        </p>
        <a href="#tasks" class="btn btn-primary btn-block">View Open Tasks</a>
      </div>
    )}

    <!-- Getting Started Section (Highlighted) -->
    <div class="sidebar-section highlight">
      <GettingStarted client:load />
    </div>
  </div>
</DashboardLayout>
